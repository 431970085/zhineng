<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习路径图</title>
    <link rel="stylesheet" type="text/css" href="./static/layui/css/layui.css"/>
    <link rel="stylesheet" href="./static/layui/style/admin.css" media="all">
    <link rel="stylesheet" href="./static/layui/style/login.css" media="all">
    <script src="./static/layui/layui.js"></script>
    <script src="./static/js/vue.js"></script>
    <script src="./static/js/axios.min.js"></script>
    <script src="request.js"></script>
    <script src="./static/echarts/jquery.3.6.0.min.js"></script>
    <script src="./static/echarts/echarts.5.0.2.js"></script>
</head>

<body>
<!-- 定义一个 DOM 容器用于显示 ECharts 图表 -->
<div id="main" style="width: 100%; height: 600px;"></div>
<script>

    var layer
    layui.use(['layer'], function () {
        layer = layui.layer;
    });

    //请求路径
    var url = ctx + "/selectAction";
    var loginUserinfo = JSON.parse(sessionStorage.getItem('loginUserinfo'));//获取登录信息
    var uid = loginUserinfo.id;
    var uname = loginUserinfo.name;
    //执行的sql语句  左表查询右边
    var sql = `
              SELECT
                lt.id as val,
                lt.title as name ,
                lt.type,
                CASE
                    WHEN rt.tid IS NOT NULL THEN 1
                    ELSE 0
                END AS exists_in_right_table
            FROM
                datainfo lt
            LEFT JOIN
                studyinfo rt ON lt.id = rt.tid and uid=${uid} ;
        `;
    //初始化echarts实例
    //柱状图
    function getpieChart() {

        $.ajax({
            url: url,
            type: 'POST',
            dataType: 'json',
            data: {"sql": sql},
            cache: false,
            success: function (data) {
                var data = data.data;
                var namesArr = [];
                var myLinks = [];
                var x_index = 100;
                var y_index = 300;
                var source_index = "";
                var type_index = "";
                for (let j = 0; j < data.length; j++) {
                    var name = data[j].name;
                    var val = data[j].val;
                    var type = data[j].type;
                    if (type_index != type) {
                        x_index = 100;
                        if (type_index != "") {
                            y_index = y_index + 300;
                        }
                        var obj01 = {name: type, x: x_index, y: y_index};
                        namesArr.push(obj01);
                        x_index = x_index + 400
                        source_index = type;
                        type_index = type;
                        continue;
                    }
                    var exists_in_right_table = data[j].exists_in_right_table;
                    if (exists_in_right_table == 0) {
                        var obj01 = {name: name, x: x_index, y: y_index}
                        x_index = x_index + 400;
                        namesArr.push(obj01);
                        var linkObj = {
                            source: source_index,
                            target: name,
                        };
                        myLinks.push(linkObj)
                        source_index = name;
                    }
                }
                //去重
                const uniqueArr = [];
                const ids = new Set();
                namesArr.forEach(item => {
                    if (!ids.has(item.name)) {
                        uniqueArr.push(item);
                        ids.add(item.name);
                    }
                });
                namesArr = uniqueArr;

                console.log(namesArr)


                console.log(myLinks)


                // 初始化 ECharts 实例
                var myChart = echarts.init(document.getElementById('main'));


                // 配置图表选项
                var option = {
                    // 添加标题组件
                    title: {
                        text: '学习路径图',
                        left: 'center'
                    },
                    // 添加提示框组件
                    tooltip: {
                        trigger: 'item',
                        formatter: '{b}'
                    },
                    series: [
                        {
                            type: 'graph',
                            layout: 'none', // 使用直角坐标系布局，不使用力导向布局
                            symbolSize: 50,
                            edgeSymbol: ['circle', 'arrow'],
                            edgeSymbolSize: [10, 20], // 箭头大小和边的大小
                            data: namesArr,
                            links: myLinks,
                            lineStyle: {
                                color: 'source', // 使用源节点的颜色作为线条颜色
                                curveness: 0.3, // 线条曲度，非直角连接效果
                                width: 2 // 线条宽度
                            },
                            // 节点标签样式
                            label: {
                                show: true,
                                position: 'top',
                                color: '#333',
                                fontSize: 12
                            },
                            // 节点样式
                            itemStyle: {
                                color: '#008CBA'
                            }
                        }
                    ]
                };

                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option);

                // 为节点添加点击事件
                myChart.on('click', 'series.graph.data', function (params) {
                    console.log('你点击了节点：' + params.name);

                    var title01 = params.name;

                    // 弹出确认框
                    layer.confirm(`你确定要学习${title01}知识吗？`, {
                        btn: ['确定', '取消'] // 按钮组
                    }, function () {
                        // 点击确定按钮后的回调函数
                        //layer.msg('你点击了确定', { icon: 1 });
                        var url = ctx + "/selectAction";
                        //执行的sql语句  左表查询右边
                        var sql = `select * from datainfo where title='${title01}' limit 1`;
                        data = {"sql": sql}
                        $.post(url, data, function (response) {
                            var data = response.data[0];
                            var dataid = data.id;
                            sessionStorage.setItem("datainfoid", dataid);
                            //location.href = "detail.html";
                            window.open('detail.html', '_blank');
                        });
                    }, function () {
                        // 点击取消按钮后的回调函数
                        layer.msg('你点击了取消', {icon: 2});
                    });


                });
            },
            error: function (responseStr) {
                alert("数据类模板数量查询失败！");
            }
        });
    }

    $(function () {
        //加载饼图
        getpieChart();
    });
</script>
</body>

</html>
